<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Good Old Tetris - Pixel Perfect</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap');

        :root {
            --case-color: #f2cf42;
            --lens-black: #181818;
            --housing-color: #dcc035; /* Â±èÂπïÂ§ñÂúàÁöÑÊñúÈù¢ÈªÑ */
            --lcd-bg: #9ead86;     
            --pixel-off: #8c9a74;
            --pixel-on: #111;
            --btn-blue: #5b6ee1;
            --btn-blue-shadow: #3242a6;
            
            /* Ê†∏ÂøÉÂ∞∫ÂØ∏ÂÆö‰πâ - Êñπ‰æøÁªü‰∏Ä‰øÆÊîπ */
            /* 18px * 20Ë°å = 360px È´òÂ∫¶ */
            /* 18px * 10Âàó = 180px ÂÆΩÂ∫¶ */
            --block-size: 18px;
            --board-w: 180px;
            --board-h: 360px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #3a8d86;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            font-family: 'VT323', monospace;
        }

        /* --- Â§ñÂ£≥ --- */
        .game-boy {
            background-color: var(--case-color);
            width: 460px;  /*Á®çÂæÆÊî∂Á™Ñ‰∏ÄÁÇπÔºåÊõ¥Á≤æËá¥*/
            height: 780px;
            border-radius: 20px 20px 50px 50px;
            padding: 25px;
            box-shadow: 
                inset 4px 4px 10px rgba(255,255,255,0.4),
                inset -4px -4px 10px rgba(0,0,0,0.1),
                20px 25px 50px rgba(0,0,0,0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- ÈªëËâ≤ÁéªÁíÉÊ°Ü (Lens) --- */
        .lens-area {
            width: 100%;
            background-color: var(--lens-black);
            border-radius: 12px 12px 40px 12px; /* ÁªèÂÖ∏ÁöÑÈùûÂØπÁß∞ÂúÜËßí */
            padding: 15px 30px 35px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
            position: relative;
            z-index: 5;
        }

        /* È°∂ÈÉ®Êù°Á∫πË£ÖÈ•∞ */
        .lens-header {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
            gap: 15px;
        }
        .brand-text {
            color: #e0e0e0;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 16px;
            letter-spacing: 0.5px;
        }
        .deco-dots { display: flex; gap: 4px; }
        .square-dot { width: 8px; height: 8px; background: #333; }

        /* --- Â±èÂπïÂ§ñÂ£≥ (Housing) --- */
        .screen-housing {
            background-color: var(--housing-color);
            padding: 15px;
            border-radius: 4px 4px 20px 4px;
            box-shadow: inset 2px 2px 6px rgba(0,0,0,0.3);
            width: 100%;
            /* ÂÖ≥ÈîÆÔºöÈò≤Ê≠¢ÂÜÖÈÉ®ÂÜÖÂÆπÊ∫¢Âá∫ÁîªÂà∞ÈªëËâ≤Âå∫Âüü‰∏ä */
            overflow: hidden; 
        }

        /* --- LCD Â±èÂπï‰∏ª‰Ωì --- */
        .lcd-screen {
            background-color: var(--lcd-bg);
            width: 100%;
            /* ËøôÈáåÈ´òÂ∫¶ÂøÖÈ°ªË∂≥Â§üÂÆπÁ∫≥ 20Ë°å * 18px = 360px */
            height: 360px; 
            border: 2px solid #758262;
            display: flex;
            position: relative;
            box-shadow: inset 3px 3px 8px rgba(0,0,0,0.15);
        }

        /* --- Ê∏∏ÊàèÂå∫ (Canvas) --- */
        .game-container {
            width: var(--board-w);
            height: var(--board-h);
            border-right: 2px solid #758262;
            position: relative;
        }

        /* CSSÁªòÂà∂ÁöÑÁΩëÊ†ºËÉåÊôØ (Pixel Perfect) */
        .grid-bg {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            /* 18px ÁöÑÁΩëÊ†º */
            background-image: 
                linear-gradient(var(--pixel-off) 1px, transparent 1px),
                linear-gradient(90deg, var(--pixel-off) 1px, transparent 1px);
            background-size: var(--block-size) var(--block-size);
            background-position: -1px -1px; /* ÂæÆË∞ÉÂØπÈΩêÁ∫ø */
            opacity: 0.6;
            z-index: 0;
        }
        /* Ê®°ÊãüÁ©∫ÂøÉÊñπÂùó */
        .grid-bg::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(rgba(0,0,0,0.05) 15%, transparent 16%);
            background-size: var(--block-size) var(--block-size);
            background-position: center;
        }

        canvas#tetris {
            display: block;
            position: relative;
            z-index: 10;
        }

        /* --- ‰æßËæπÊ†è --- */
        .sidebar {
            flex: 1;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            font-family: 'VT323', monospace;
            color: #111;
        }
        .stat-row { margin-bottom: 15px; }
        .stat-label { font-size: 14px; color: #333; font-weight: bold; margin-bottom: 0px; opacity: 0.8; text-transform: uppercase;}
        .stat-value { font-size: 22px; text-align: right; letter-spacing: 1px; font-weight: bold; line-height: 1.2;}

        .next-preview {
            width: 54px; /* 3 * 18px */
            height: 36px;
            margin-left: auto;
            margin-top: 5px;
        }

        .status-footer {
            margin-top: auto;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            font-size: 18px;
            opacity: 0.7;
        }

        /* --- Ë£ÖÈ•∞ÊñπÂùó --- */
        .deco-side {
            position: absolute;
            top: 120px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .deco-left { left: 6px; }
        .deco-right { right: 6px; }
        .d-blk {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2px;
        }
        .b-on { width: 8px; height: 8px; background: #111; }
        .b-off { width: 8px; height: 8px; border: 1px solid #333; }

        /* --- ÊéßÂà∂Âå∫ --- */
        .controls {
            width: 100%;
            flex: 1;
            position: relative;
            margin-top: 30px;
        }

        /* ÂäüËÉΩÈîÆ */
        .small-btns {
            display: flex;
            gap: 18px;
            position: absolute;
            top: 0; left: 15px;
        }
        .s-btn-wrap { display: flex; flex-direction: column; align-items: center; }
        .s-btn {
            width: 30px; height: 30px; border-radius: 50%; border: none;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2), inset 0 2px 3px rgba(255,255,255,0.4);
            margin-bottom: 6px; cursor: pointer;
        }
        .s-btn:active { transform: translateY(2px); box-shadow: inset 0 2px 3px rgba(0,0,0,0.4); }
        .green { background: #4CAF50; }
        .red { background: #E53935; }
        .s-lbl { font-size: 10px; font-weight: bold; color: #222; font-family: sans-serif; }

        /* Â§ßÊåâÈíÆ */
        .pad-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 70px;
            padding: 0 10px;
        }
        
        /* Drop Button */
        .drop-btn-wrap { position: relative; margin-left: 10px; }
        .big-btn {
            width: 100px; height: 100px; border-radius: 50%;
            background: var(--btn-blue); border: none;
            box-shadow: 0 6px 0 var(--btn-blue-shadow), 5px 8px 15px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 var(--btn-blue-shadow); }
        .drop-lbl { position: absolute; bottom: -30px; width: 100%; text-align: center; font-weight: bold; color: #222; font-size: 14px; font-family: sans-serif;}

        /* D-Pad */
        .dpad {
            display: grid;
            grid-template-columns: 50px 50px 50px;
            grid-template-rows: 50px 50px 50px;
            margin-right: 5px;
        }
        .d-btn {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--btn-blue); border: none;
            box-shadow: 0 4px 0 var(--btn-blue-shadow), 2px 4px 8px rgba(0,0,0,0.2);
            margin: auto; cursor: pointer; position: relative;
        }
        .d-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 var(--btn-blue-shadow); }
        .d-lbl { position: absolute; font-size: 12px; font-weight: bold; color: #222; font-family: sans-serif; white-space: nowrap; }
        
        .up { grid-column: 2; grid-row: 1; }
        .left { grid-column: 1; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }
        .down { grid-column: 2; grid-row: 3; }
        
        .up .d-lbl { left: 55px; top: 16px; }
        .left .d-lbl { bottom: -20px; left: 10px; }
        .right .d-lbl { bottom: -20px; left: 5px; }
        .down .d-lbl { bottom: -20px; left: 8px; }

        /* Arrows */
        .arrows { grid-column: 2; grid-row: 2; position: relative; }
        .tri { position: absolute; width: 0; height: 0; border-style: solid; }
        .t-u { border-width: 0 4px 6px 4px; border-color: transparent transparent #111 transparent; top: 5px; left: 21px; }
        .t-d { border-width: 6px 4px 0 4px; border-color: #111 transparent transparent transparent; bottom: 5px; left: 21px; }
        .t-l { border-width: 4px 6px 4px 0; border-color: transparent #111 transparent transparent; left: 5px; top: 21px; }
        .t-r { border-width: 4px 0 4px 6px; border-color: transparent transparent transparent #111; right: 5px; top: 21px; }

    </style>
</head>
<body>

<div class="game-boy">
    <!-- ‰æßËæπË£ÖÈ•∞ÁÇπ -->
    <div class="deco-side deco-left">
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-off"></div><div class="b-on"></div></div>
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-on"></div><div class="b-on"></div></div>
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-off"></div><div class="b-off"></div></div>
        <div class="b-on"></div>
    </div>
    <div class="deco-side deco-right">
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-off"></div><div class="b-on"></div></div>
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-on"></div><div class="b-on"></div></div>
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-off"></div><div class="b-off"></div></div>
        <div class="b-on"></div>
    </div>

    <!-- ÈªëËâ≤ÁéªÁíÉÂå∫ -->
    <div class="lens-area">
        <div class="lens-header">
            <div class="deco-dots"><div class="square-dot"></div><div class="square-dot"></div><div class="square-dot"></div><div class="square-dot"></div></div>
            <div class="brand-text">Good Old Tetris</div>
            <div class="deco-dots"><div class="square-dot"></div><div class="square-dot"></div><div class="square-dot"></div><div class="square-dot"></div></div>
        </div>

        <div class="screen-housing">
            <div class="lcd-screen">
                <div class="game-container">
                    <div class="grid-bg"></div>
                    <!-- 180px x 360px Canvas -->
                    <canvas id="tetris" width="180" height="360"></canvas>
                </div>

                <div class="sidebar">
                    <div class="stat-row">
                        <div class="stat-label">Max</div>
                        <div class="stat-value" id="high-score">0</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">Cleans</div>
                        <div class="stat-value" id="cleans">0</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">Level</div>
                        <div class="stat-value" id="level">1</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">Next</div>
                        <div class="next-preview">
                            <canvas id="next" width="54" height="36"></canvas>
                        </div>
                    </div>
                    <div class="status-footer">
                        <span id="sound-icon">üîä</span>&nbsp;<span id="clock">00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Â∫ïÈÉ®ÊåâÈíÆ -->
    <div class="controls">
        <div class="small-btns">
            <div class="s-btn-wrap">
                <button class="s-btn green" id="btn-pause"></button>
                <span class="s-lbl">Pause(P)</span>
            </div>
            <div class="s-btn-wrap">
                <button class="s-btn green" id="btn-sound"></button>
                <span class="s-lbl">Sound(S)</span>
            </div>
            <div class="s-btn-wrap">
                <button class="s-btn red" id="btn-reset"></button>
                <span class="s-lbl">Reset(R)</span>
            </div>
        </div>

        <div class="pad-area">
            <div class="drop-btn-wrap">
                <button class="big-btn" id="btn-drop"></button>
                <div class="drop-lbl">Drop (SPACE)</div>
            </div>

            <div class="dpad">
                <div class="arrows">
                    <div class="tri t-u"></div><div class="tri t-d"></div>
                    <div class="tri t-l"></div><div class="tri t-r"></div>
                </div>
                <button class="d-btn up" id="btn-rotate"><span class="d-lbl">Rotation</span></button>
                <button class="d-btn left" id="btn-left"><span class="d-lbl">Left</span></button>
                <button class="d-btn right" id="btn-right"><span class="d-lbl">Right</span></button>
                <button class="d-btn down" id="btn-down"><span class="d-lbl">Down</span></button>
            </div>
        </div>
    </div>
</div>

<script>
    /**
     * Ê∏∏ÊàèÊ†∏ÂøÉÈÄªËæë
     * ‰øÆÊ≠£ÈáçÁÇπÔºöBlockSize 18pxÔºåÊÄªÈ´òÂ∫¶ 360pxÔºåÂÆåÁæéÂØπÈΩê
     */
    const canvas = document.getElementById('tetris');
    const ctx = canvas.getContext('2d');
    const nextCanvas = document.getElementById('next');
    const nextCtx = nextCanvas.getContext('2d');

    const BLOCK_SIZE = 18; // Ê†∏ÂøÉÂ∞∫ÂØ∏
    const DRAW_SIZE = 16;  // ÂÆûÈôÖÁªòÂà∂Â§ßÂ∞è (Áïô2pxÈó¥Èöô)
    
    // È¢ÑËßàÁ™óÂè£Áº©Êîæ
    nextCtx.scale(14, 14);

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let soundEnabled = true;

    // ÁÆÄÂçïÈü≥ÊïàÂêàÊàê
    function playSound(type) {
        if (!soundEnabled || audioCtx.state === 'suspended') {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (!soundEnabled) return;
        }
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'move') {
            osc.type = 'square'; osc.frequency.setValueAtTime(220, now);
            gain.gain.setValueAtTime(0.02, now); osc.start(now); osc.stop(now + 0.03);
        } else if (type === 'rotate') {
            osc.type = 'square'; osc.frequency.setValueAtTime(440, now);
            gain.gain.setValueAtTime(0.02, now); osc.start(now); osc.stop(now + 0.04);
        } else if (type === 'drop') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(120, now); osc.frequency.exponentialRampToValueAtTime(40, now+0.1);
            gain.gain.setValueAtTime(0.08, now); osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'clear') {
            osc.type = 'square'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1760, now+0.1);
            gain.gain.setValueAtTime(0.05, now); osc.start(now); osc.stop(now + 0.2);
        } else if (type === 'gameover') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(220, now); osc.frequency.linearRampToValueAtTime(50, now+1);
            gain.gain.setValueAtTime(0.1, now); osc.start(now); osc.stop(now+1);
        }
    }

    const PIECES = 'TJLOSZI';
    const SHAPES = {
        'T': [[0,1,0],[1,1,1],[0,0,0]],
        'O': [[2,2],[2,2]],
        'L': [[0,3,0],[0,3,0],[0,3,3]],
        'J': [[0,4,0],[0,4,0],[4,4,0]],
        'I': [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]],
        'S': [[0,6,6],[6,6,0],[0,0,0]],
        'Z': [[7,7,0],[0,7,7],[0,0,0]]
    };

    // ÂàùÂßãÂåñ
    const arena = createMatrix(10, 20);
    const player = { pos: {x:0, y:0}, matrix:null, next:null };
    let dropCounter = 0, dropInterval = 1000, lastTime = 0;
    let isPaused = false, isGameOver = false;
    let score = 0, cleans = 0, level = 1, highScore = localStorage.getItem('tetris_hs')||0;
    document.getElementById('high-score').innerText = highScore;

    let bag = [];
    function getNextPiece() {
        if (bag.length === 0) {
            bag = PIECES.split('');
            for(let i=bag.length-1; i>0; i--) {
                const j = Math.floor(Math.random()*(i+1));
                [bag[i], bag[j]] = [bag[j], bag[i]];
            }
        }
        const type = bag.pop();
        return { matrix: SHAPES[type].map(r=>[...r]), type };
    }

    function createMatrix(w, h) {
        const m = []; while(h--) m.push(new Array(w).fill(0)); return m;
    }

    function collide(arena, player) {
        const [m, o] = [player.matrix, player.pos];
        for(let y=0; y<m.length; ++y) {
            for(let x=0; x<m[y].length; ++x) {
                if(m[y][x] !== 0 && (arena[y+o.y] && arena[y+o.y][x+o.x]) !== 0) return true;
            }
        }
        return false;
    }

    function draw() {
        // Ê∏ÖÁ©∫ (ÂÖ®ÈÄèÊòéÔºåÈú≤Âá∫CSSÁΩëÊ†º)
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ÁªòÂà∂ Arena
        drawMatrix(arena, {x:0, y:0}, ctx);

        // ÁªòÂà∂ Ghost
        if (!isPaused && !isGameOver) {
            const ghost = { ...player.pos };
            while (!collide(arena, {pos:ghost, matrix:player.matrix})) ghost.y++;
            ghost.y--;
            if (ghost.y !== player.pos.y) drawMatrix(player.matrix, ghost, ctx, true);
        }

        // ÁªòÂà∂ Player
        drawMatrix(player.matrix, player.pos, ctx);
    }

    function drawMatrix(matrix, offset, context, isGhost=false) {
        matrix.forEach((row, y) => {
            row.forEach((val, x) => {
                if (val !== 0) {
                    // Á≤æÁ°ÆÂùêÊ†áËÆ°ÁÆó
                    const px = (x + offset.x) * BLOCK_SIZE;
                    const py = (y + offset.y) * BLOCK_SIZE;
                    const gap = (BLOCK_SIZE - DRAW_SIZE) / 2;

                    if (isGhost) {
                        context.fillStyle = 'rgba(17,17,17,0.15)';
                        context.fillRect(px+1, py+1, BLOCK_SIZE-2, BLOCK_SIZE-2);
                    } else {
                        context.fillStyle = '#111';
                        // ÁªòÂà∂‰∏ª‰Ωì 16px (18-2)
                        context.fillRect(px+gap, py+gap, DRAW_SIZE, DRAW_SIZE);
                        // ÂÜÖÈÉ®È´òÂÖâÁÇπ (Â¢ûÂº∫LCDË¥®ÊÑü)
                        context.fillStyle = '#333';
                        context.fillRect(px+gap+3, py+gap+3, DRAW_SIZE-6, DRAW_SIZE-6);
                    }
                }
            });
        });
    }

    function drawNext() {
        nextCtx.clearRect(0,0, nextCanvas.width, nextCanvas.height);
        if(!player.next) return;
        const m = player.next.matrix;
        const ox = (4 - m[0].length)/2;
        const oy = (3 - m.length)/2; // Á®çÂæÆ‰øÆÊ≠£Â±Ö‰∏≠
        m.forEach((row, y) => {
            row.forEach((val, x) => {
                if(val) {
                    nextCtx.fillStyle = '#111';
                    nextCtx.fillRect(x+ox, y+oy, 0.9, 0.9);
                }
            });
        });
    }

    function merge(arena, player) {
        player.matrix.forEach((row, y) => {
            row.forEach((val, x) => {
                if(val) arena[y+player.pos.y][x+player.pos.x] = val;
            });
        });
    }

    function rotate(m, dir) {
        for(let y=0; y<m.length; ++y) for(let x=0; x<y; ++x) [m[x][y], m[y][x]] = [m[y][x], m[x][y]];
        if(dir>0) m.forEach(row=>row.reverse()); else m.reverse();
    }

    function playerDrop() {
        player.pos.y++;
        if(collide(arena, player)) {
            player.pos.y--;
            merge(arena, player);
            playSound('drop');
            playerReset();
            arenaSweep();
        }
        dropCounter = 0;
    }

    function playerHardDrop() {
        while(!collide(arena, player)) player.pos.y++;
        player.pos.y--;
        merge(arena, player);
        playSound('drop');
        playerReset();
        arenaSweep();
        dropCounter = 0;
    }

    function playerMove(dir) {
        player.pos.x += dir;
        if(collide(arena, player)) player.pos.x -= dir;
        else playSound('move');
    }

    function playerRotate(dir) {
        const pos = player.pos.x;
        let offset = 1;
        rotate(player.matrix, dir);
        while(collide(arena, player)) {
            player.pos.x += offset;
            offset = -(offset + (offset>0 ? 1 : -1));
            if(offset > player.matrix[0].length) {
                rotate(player.matrix, -dir);
                player.pos.x = pos;
                return;
            }
        }
        playSound('rotate');
    }

    function playerReset() {
        if(!player.next) player.next = getNextPiece();
        player.matrix = player.next.matrix;
        player.next = getNextPiece();
        drawNext();
        player.pos.y = 0;
        player.pos.x = (arena[0].length/2 | 0) - (player.matrix[0].length/2 | 0);
        if(collide(arena, player)) {
            isGameOver = true;
            playSound('gameover');
            if(score > highScore) {
                highScore = score;
                localStorage.setItem('tetris_hs', highScore);
                document.getElementById('high-score').innerText = highScore;
            }
        }
    }

    function arenaSweep() {
        let count = 0;
        outer: for(let y=arena.length-1; y>0; --y) {
            for(let x=0; x<arena[y].length; ++x) if(arena[y][x] === 0) continue outer;
            const row = arena.splice(y, 1)[0].fill(0);
            arena.unshift(row);
            ++y; count++;
        }
        if(count > 0) {
            playSound('clear');
            const scores = [0, 40, 100, 300, 1200];
            score += scores[count] * level;
            cleans += count;
            level = Math.floor(cleans/10) + 1;
            dropInterval = Math.max(100, 1000 - (level-1)*100);
            updateStats();
        }
    }

    function updateStats() {
        document.getElementById('cleans').innerText = cleans;
        document.getElementById('level').innerText = level;
    }

    function update(time = 0) {
        if(isPaused || isGameOver) return;
        const dt = time - lastTime;
        lastTime = time;
        dropCounter += dt;
        if(dropCounter > dropInterval) playerDrop();
        draw();
        requestAnimationFrame(update);
    }

    function resetGame() {
        arena.forEach(r => r.fill(0));
        score = 0; cleans = 0; level = 1; dropInterval = 1000;
        isGameOver = false; isPaused = false;
        bag = [];
        updateStats();
        player.next = null;
        playerReset();
        update();
    }

    // ÁªëÂÆö‰∫ã‰ª∂
    document.addEventListener('keydown', e => {
        if(isGameOver && e.keyCode === 82) { resetGame(); return; }
        if(e.keyCode === 80) { isPaused=!isPaused; if(!isPaused) update(); return; }
        if(e.keyCode === 83) { soundEnabled=!soundEnabled; document.getElementById('sound-icon').style.opacity=soundEnabled?1:0.3; return; }
        if(isPaused || isGameOver) return;
        
        if(e.keyCode === 37) playerMove(-1);
        else if(e.keyCode === 39) playerMove(1);
        else if(e.keyCode === 40) playerDrop();
        else if(e.keyCode === 38) playerRotate(1);
        else if(e.keyCode === 32) playerHardDrop();
    });

    function bind(id, action) {
        const btn = document.getElementById(id);
        const h = (e) => { e.preventDefault(); if(audioCtx.state==='suspended') audioCtx.resume(); action(); };
        btn.addEventListener('mousedown', h); btn.addEventListener('touchstart', h);
    }
    bind('btn-left', ()=>!isPaused&&!isGameOver&&playerMove(-1));
    bind('btn-right', ()=>!isPaused&&!isGameOver&&playerMove(1));
    bind('btn-down', ()=>!isPaused&&!isGameOver&&playerDrop());
    bind('btn-rotate', ()=>!isPaused&&!isGameOver&&playerRotate(1));
    bind('btn-drop', ()=>!isPaused&&!isGameOver&&playerHardDrop());
    bind('btn-pause', ()=>{isPaused=!isPaused; if(!isPaused)update();});
    bind('btn-reset', resetGame);
    bind('btn-sound', ()=>{soundEnabled=!soundEnabled; document.getElementById('sound-icon').style.opacity=soundEnabled?1:0.3;});

    setInterval(()=>{
        const d = new Date();
        document.getElementById('clock').innerText = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }, 1000);

    resetGame();
</script>
</body>
</html>
