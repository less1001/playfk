<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Good Old Tetris - Final Perfect</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap');

        :root {
            --case-color: #f2cf42;
            --lens-black: #181818;
            --housing-color: #dcc035;
            --lcd-bg: #9ead86;     
            --pixel-off: #8c9a74;
            --pixel-on: #111;
            --btn-blue: #5b6ee1;
            --btn-blue-shadow: #3242a6;
            --base-width: 460px;
            --base-height: 780px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #2c6b65;
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            font-family: 'VT323', monospace;
            touch-action: none; 
        }

        .game-boy {
            width: var(--base-width); height: var(--base-height);
            background-color: var(--case-color);
            border-radius: 20px 20px 50px 50px; padding: 25px;
            box-shadow: inset 4px 4px 10px rgba(255,255,255,0.4), inset -4px -4px 10px rgba(0,0,0,0.15), 0px 0px 50px rgba(0,0,0,0.5);
            position: relative; display: flex; flex-direction: column; align-items: center;
            visibility: hidden; transform-origin: center center;
        }

        .lens-area {
            width: 100%; background-color: var(--lens-black);
            border-radius: 12px 12px 40px 12px; padding: 15px 30px 35px 30px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2); position: relative; z-index: 5;
        }

        .lens-header {
            width: 100%; display: flex; justify-content: center; align-items: center;
            margin-bottom: 12px; gap: 15px;
        }
        .brand-text { color: #e0e0e0; font-family: sans-serif; font-weight: bold; font-size: 16px; letter-spacing: 0.5px; }
        .deco-dots { display: flex; gap: 4px; }
        .square-dot { width: 8px; height: 8px; background: #333; }

        .screen-housing {
            background-color: var(--housing-color); padding: 15px;
            border-radius: 4px 4px 20px 4px; box-shadow: inset 2px 2px 6px rgba(0,0,0,0.3);
            width: 100%; overflow: hidden; 
        }

        .lcd-screen {
            background-color: var(--lcd-bg); width: 100%; height: 360px; 
            border: 2px solid #758262; display: flex; position: relative;
            box-shadow: inset 3px 3px 8px rgba(0,0,0,0.15);
        }

        .game-container { width: 180px; height: 360px; border-right: 2px solid #758262; position: relative; }

        .grid-bg {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(var(--pixel-off) 1px, transparent 1px), linear-gradient(90deg, var(--pixel-off) 1px, transparent 1px);
            background-size: 18px 18px; background-position: -1px -1px; opacity: 0.6; z-index: 0;
        }
        .grid-bg::after {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(rgba(0,0,0,0.05) 15%, transparent 16%);
            background-size: 18px 18px; background-position: center;
        }

        canvas#tetris { display: block; position: relative; z-index: 10; }

        .sidebar {
            flex: 1; padding: 12px 8px; display: flex; flex-direction: column;
            font-family: 'VT323', monospace; color: #111;
        }
        .stat-row { margin-bottom: 15px; }
        .stat-label { font-size: 14px; color: #333; font-weight: bold; margin-bottom: 0px; opacity: 0.8; text-transform: uppercase;}
        .stat-value { font-size: 22px; text-align: right; letter-spacing: 1px; font-weight: bold; line-height: 1.2;}
        .next-preview { width: 54px; height: 36px; margin-left: auto; margin-top: 5px; }
        .status-footer { margin-top: auto; display: flex; justify-content: flex-end; align-items: center; font-size: 20px; opacity: 0.8; }

        .deco-side { position: absolute; top: 120px; display: flex; flex-direction: column; gap: 12px; }
        .deco-left { left: 6px; } .deco-right { right: 6px; }
        .d-blk { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; }
        .b-on { width: 8px; height: 8px; background: #111; } .b-off { width: 8px; height: 8px; border: 1px solid #333; }

        .controls { width: 100%; flex: 1; position: relative; margin-top: 30px; }
        .small-btns { display: flex; gap: 18px; position: absolute; top: 0; left: 15px; }
        .s-btn-wrap { display: flex; flex-direction: column; align-items: center; }
        .s-btn {
            width: 30px; height: 30px; border-radius: 50%; border: none;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2), inset 0 2px 3px rgba(255,255,255,0.4);
            margin-bottom: 6px; cursor: pointer;
        }
        .s-btn:active { transform: translateY(2px); box-shadow: inset 0 2px 3px rgba(0,0,0,0.4); }
        .green { background: #4CAF50; } .red { background: #E53935; }
        .s-lbl { font-size: 10px; font-weight: bold; color: #222; font-family: sans-serif; }

        .pad-area { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 70px; padding: 0 10px; }
        .drop-btn-wrap { position: relative; margin-left: 10px; }
        .big-btn {
            width: 100px; height: 100px; border-radius: 50%;
            background: var(--btn-blue); border: none;
            box-shadow: 0 6px 0 var(--btn-blue-shadow), 5px 8px 15px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 var(--btn-blue-shadow); }
        .drop-lbl { position: absolute; bottom: -30px; width: 100%; text-align: center; font-weight: bold; color: #222; font-size: 14px; font-family: sans-serif;}

        .dpad { display: grid; grid-template-columns: 50px 50px 50px; grid-template-rows: 50px 50px 50px; margin-right: 5px; }
        .d-btn {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--btn-blue); border: none;
            box-shadow: 0 4px 0 var(--btn-blue-shadow), 2px 4px 8px rgba(0,0,0,0.2);
            margin: auto; cursor: pointer; position: relative;
        }
        .d-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 var(--btn-blue-shadow); }
        .d-lbl { position: absolute; font-size: 12px; font-weight: bold; color: #222; font-family: sans-serif; white-space: nowrap; }
        
        .up { grid-column: 2; grid-row: 1; } .left { grid-column: 1; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; } .down { grid-column: 2; grid-row: 3; }
        .up .d-lbl { left: 55px; top: 16px; } .left .d-lbl { bottom: -20px; left: 10px; }
        .right .d-lbl { bottom: -20px; left: 5px; } .down .d-lbl { bottom: -20px; left: 8px; }

        .arrows { grid-column: 2; grid-row: 2; position: relative; }
        .tri { position: absolute; width: 0; height: 0; border-style: solid; }
        .t-u { border-width: 0 4px 6px 4px; border-color: transparent transparent #111 transparent; top: 5px; left: 21px; }
        .t-d { border-width: 6px 4px 0 4px; border-color: #111 transparent transparent transparent; bottom: 5px; left: 21px; }
        .t-l { border-width: 4px 6px 4px 0; border-color: transparent #111 transparent transparent; left: 5px; top: 21px; }
        .t-r { border-width: 4px 0 4px 6px; border-color: transparent transparent transparent #111; right: 5px; top: 21px; }
    </style>
</head>
<body>

<div class="game-boy">
    <div class="deco-side deco-left">
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-off"></div><div class="b-on"></div></div>
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-on"></div><div class="b-on"></div></div>
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-off"></div><div class="b-off"></div></div>
        <div class="b-on"></div>
    </div>
    <div class="deco-side deco-right">
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-off"></div><div class="b-on"></div></div>
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-on"></div><div class="b-on"></div></div>
        <div class="d-blk"><div class="b-on"></div><div class="b-on"></div><div class="b-off"></div><div class="b-off"></div></div>
        <div class="b-on"></div>
    </div>

    <div class="lens-area">
        <div class="lens-header">
            <div class="deco-dots"><div class="square-dot"></div><div class="square-dot"></div><div class="square-dot"></div><div class="square-dot"></div></div>
            <div class="brand-text">Good Old Tetris</div>
            <div class="deco-dots"><div class="square-dot"></div><div class="square-dot"></div><div class="square-dot"></div><div class="square-dot"></div></div>
        </div>

        <div class="screen-housing">
            <div class="lcd-screen">
                <div class="game-container">
                    <div class="grid-bg"></div>
                    <canvas id="tetris" width="180" height="360"></canvas>
                </div>

                <div class="sidebar">
                    <div class="stat-row">
                        <div class="stat-label">Max</div>
                        <div class="stat-value" id="high-score">0</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">Cleans</div>
                        <div class="stat-value" id="cleans">0</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">Level</div>
                        <div class="stat-value" id="level">1</div>
                    </div>
                    <div class="stat-row">
                        <div class="stat-label">Next</div>
                        <div class="next-preview">
                            <canvas id="next" width="54" height="36"></canvas>
                        </div>
                    </div>
                    <div class="status-footer">
                        <span id="sound-icon">ðŸ”Š</span>&nbsp;<span id="clock">00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="small-btns">
            <div class="s-btn-wrap"><button class="s-btn green" id="btn-pause"></button><span class="s-lbl">Pause(P)</span></div>
            <div class="s-btn-wrap"><button class="s-btn green" id="btn-sound"></button><span class="s-lbl">Sound(S)</span></div>
            <div class="s-btn-wrap"><button class="s-btn red" id="btn-reset"></button><span class="s-lbl">Reset(R)</span></div>
        </div>

        <div class="pad-area">
            <div class="drop-btn-wrap">
                <button class="big-btn" id="btn-drop"></button>
                <div class="drop-lbl">Drop (SPACE)</div>
            </div>

            <div class="dpad">
                <div class="arrows">
                    <div class="tri t-u"></div><div class="tri t-d"></div>
                    <div class="tri t-l"></div><div class="tri t-r"></div>
                </div>
                <button class="d-btn up" id="btn-rotate"><span class="d-lbl">Rotation</span></button>
                <button class="d-btn left" id="btn-left"><span class="d-lbl">Left</span></button>
                <button class="d-btn right" id="btn-right"><span class="d-lbl">Right</span></button>
                <button class="d-btn down" id="btn-down"><span class="d-lbl">Down</span></button>
            </div>
        </div>
    </div>
</div>

<script>
    function fitToScreen() {
        const gameBoy = document.querySelector('.game-boy');
        const padding = 10;
        const availableWidth = window.innerWidth - padding;
        const availableHeight = window.innerHeight - padding;
        const baseWidth = 460;
        const baseHeight = 780;
        const scale = Math.min(availableWidth / baseWidth, availableHeight / baseHeight);
        gameBoy.style.transform = `scale(${scale})`;
        gameBoy.style.visibility = 'visible';
    }
    window.addEventListener('resize', fitToScreen);
    window.addEventListener('load', fitToScreen);

    const canvas = document.getElementById('tetris');
    const ctx = canvas.getContext('2d');
    const nextCanvas = document.getElementById('next');
    const nextCtx = nextCanvas.getContext('2d');
    const BLOCK_SIZE = 18; 
    const DRAW_SIZE = 16;  
    nextCtx.scale(14, 14);

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const VOLUME_LEVELS = [0, 0.1, 0.3, 0.8]; 
    const VOLUME_ICONS = ['ðŸ”‡', 'ðŸ”ˆ', 'ðŸ”‰', 'ðŸ”Š'];
    let volumeIndex = 2; 
    
    function updateSoundIcon() {
        document.getElementById('sound-icon').innerText = VOLUME_ICONS[volumeIndex];
    }

    function playSound(type) {
        const masterVolume = VOLUME_LEVELS[volumeIndex];
        if (masterVolume === 0) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();
        filter.type = "lowpass";
        filter.frequency.value = 1000;

        osc.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        const setVol = (v) => gain.gain.setValueAtTime(v * masterVolume, now);

        if (type === 'move') {
            osc.type = 'square'; osc.frequency.setValueAtTime(220, now);
            setVol(0.05); osc.start(now); osc.stop(now + 0.03);
        } else if (type === 'rotate') {
            osc.type = 'square'; osc.frequency.setValueAtTime(440, now);
            setVol(0.05); osc.start(now); osc.stop(now + 0.04);
        } else if (type === 'drop') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(120, now); osc.frequency.exponentialRampToValueAtTime(40, now+0.1);
            setVol(0.2); osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'clear') {
            osc.type = 'square'; osc.frequency.setValueAtTime(880, now); osc.frequency.setValueAtTime(1760, now+0.1);
            setVol(0.15); osc.start(now); osc.stop(now + 0.2);
        } else if (type === 'gameover') {
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(220, now); osc.frequency.linearRampToValueAtTime(50, now+1);
            setVol(0.2); osc.start(now); osc.stop(now+1);
        }
    }

    const PIECES = 'TJLOSZI';
    const SHAPES = {
        'T': [[0,1,0],[1,1,1],[0,0,0]], 'O': [[2,2],[2,2]], 'L': [[0,3,0],[0,3,0],[0,3,3]],
        'J': [[0,4,0],[0,4,0],[4,4,0]], 'I': [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]],
        'S': [[0,6,6],[6,6,0],[0,0,0]], 'Z': [[7,7,0],[0,7,7],[0,0,0]]
    };

    const arena = createMatrix(10, 20);
    const player = { pos: {x:0, y:0}, matrix:null, next:null };
    let dropCounter = 0, dropInterval = 1000, lastTime = 0;
    let isPaused = false, isGameOver = false;
    let score = 0, cleans = 0, level = 1, highScore = localStorage.getItem('tetris_hs')||0;
    document.getElementById('high-score').innerText = highScore;

    let bag = [];
    function getNextPiece() {
        if (bag.length === 0) {
            bag = PIECES.split('');
            for(let i=bag.length-1; i>0; i--) {
                const j = Math.floor(Math.random()*(i+1));
                [bag[i], bag[j]] = [bag[j], bag[i]];
            }
        }
        const type = bag.pop();
        return { matrix: SHAPES[type].map(r=>[...r]), type };
    }

    function createMatrix(w, h) {
        const m = []; while(h--) m.push(new Array(w).fill(0)); return m;
    }

    function collide(arena, player) {
        const [m, o] = [player.matrix, player.pos];
        for(let y=0; y<m.length; ++y) {
            for(let x=0; x<m[y].length; ++x) {
                if(m[y][x] !== 0 && (arena[y+o.y] && arena[y+o.y][x+o.x]) !== 0) return true;
            }
        }
        return false;
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMatrix(arena, {x:0, y:0}, ctx);
        
        if (!isPaused && !isGameOver) {
            const ghost = { ...player.pos };
            while (!collide(arena, {pos:ghost, matrix:player.matrix})) ghost.y++;
            ghost.y--;
            if (ghost.y !== player.pos.y) drawMatrix(player.matrix, ghost, ctx, true);
        }
        drawMatrix(player.matrix, player.pos, ctx);
    }

    function drawMatrix(matrix, offset, context, isGhost=false) {
        matrix.forEach((row, y) => {
            row.forEach((val, x) => {
                if (val !== 0) {
                    const px = (x + offset.x) * BLOCK_SIZE;
                    const py = (y + offset.y) * BLOCK_SIZE;
                    const gap = (BLOCK_SIZE - DRAW_SIZE) / 2;
                    if (isGhost) {
                        context.fillStyle = 'rgba(17,17,17,0.15)';
                        context.fillRect(px+1, py+1, BLOCK_SIZE-2, BLOCK_SIZE-2);
                    } else {
                        context.fillStyle = '#111';
                        context.fillRect(px+gap, py+gap, DRAW_SIZE, DRAW_SIZE);
                        context.fillStyle = '#333';
                        context.fillRect(px+gap+3, py+gap+3, DRAW_SIZE-6, DRAW_SIZE-6);
                    }
                }
            });
        });
    }

    function drawNext() {
        nextCtx.clearRect(0,0, nextCanvas.width, nextCanvas.height);
        if(!player.next) return;
        const m = player.next.matrix;
        const ox = (4 - m[0].length)/2;
        const oy = (3 - m.length)/2; 
        m.forEach((row, y) => {
            row.forEach((val, x) => {
                if(val) {
                    nextCtx.fillStyle = '#111';
                    nextCtx.fillRect(x+ox, y+oy, 0.9, 0.9);
                }
            });
        });
    }

    function merge(arena, player) {
        player.matrix.forEach((row, y) => {
            row.forEach((val, x) => {
                if(val) arena[y+player.pos.y][x+player.pos.x] = val;
            });
        });
    }

    function rotate(m, dir) {
        for(let y=0; y<m.length; ++y) for(let x=0; x<y; ++x) [m[x][y], m[y][x]] = [m[y][x], m[x][y]];
        if(dir>0) m.forEach(row=>row.reverse()); else m.reverse();
    }

    // ä¿®æ”¹åŽçš„ playerDrop å‡½æ•°ï¼Œå¢žåŠ  manual å‚æ•°
    function playerDrop(manual = false) {
        player.pos.y++;
        if(collide(arena, player)) {
            player.pos.y--;
            merge(arena, player);
            playSound('drop'); // è§¦åº•éŸ³æ•ˆ
            playerReset();
            arenaSweep();
        } else {
            // å¦‚æžœæ˜¯æ‰‹åŠ¨æŒ‰ä¸‹ï¼Œä¸”æ²¡æœ‰è§¦åº•ï¼Œæ’­æ”¾ç§»åŠ¨éŸ³æ•ˆ
            if(manual) playSound('move');
        }
        dropCounter = 0;
    }

    function playerHardDrop() {
        while(!collide(arena, player)) player.pos.y++;
        player.pos.y--;
        merge(arena, player);
        playSound('drop');
        playerReset();
        arenaSweep();
        dropCounter = 0;
    }

    function playerMove(dir) {
        player.pos.x += dir;
        if(collide(arena, player)) player.pos.x -= dir;
        else playSound('move');
    }

    function playerRotate(dir) {
        const pos = player.pos.x;
        let offset = 1;
        rotate(player.matrix, dir);
        while(collide(arena, player)) {
            player.pos.x += offset;
            offset = -(offset + (offset>0 ? 1 : -1));
            if(offset > player.matrix[0].length) {
                rotate(player.matrix, -dir);
                player.pos.x = pos;
                return;
            }
        }
        playSound('rotate');
    }

    function playerReset() {
        if(!player.next) player.next = getNextPiece();
        player.matrix = player.next.matrix;
        player.next = getNextPiece();
        drawNext();
        player.pos.y = 0;
        player.pos.x = (arena[0].length/2 | 0) - (player.matrix[0].length/2 | 0);
        if(collide(arena, player)) {
            isGameOver = true;
            playSound('gameover');
            if(score > highScore) {
                highScore = score;
                localStorage.setItem('tetris_hs', highScore);
                document.getElementById('high-score').innerText = highScore;
            }
        }
    }

    function arenaSweep() {
        let count = 0;
        outer: for(let y=arena.length-1; y>0; --y) {
            for(let x=0; x<arena[y].length; ++x) if(arena[y][x] === 0) continue outer;
            const row = arena.splice(y, 1)[0].fill(0);
            arena.unshift(row);
            ++y; count++;
        }
        if(count > 0) {
            playSound('clear');
            const scores = [0, 40, 100, 300, 1200];
            score += scores[count] * level;
            cleans += count;
            level = Math.floor(cleans/10) + 1;
            dropInterval = Math.max(100, 1000 - (level-1)*100);
            updateStats();
        }
    }

    function updateStats() {
        document.getElementById('cleans').innerText = cleans;
        document.getElementById('level').innerText = level;
    }

    function update(time = 0) {
        if(isPaused || isGameOver) return;
        const dt = time - lastTime;
        lastTime = time;
        dropCounter += dt;
        if(dropCounter > dropInterval) playerDrop(); // è‡ªåŠ¨ä¸‹è½ä¸ä¼ å‚æ•°ï¼Œé»˜è®¤ falseï¼Œæ— éŸ³æ•ˆ
        draw();
        requestAnimationFrame(update);
    }

    function resetGame() {
        arena.forEach(r => r.fill(0));
        score = 0; cleans = 0; level = 1; dropInterval = 1000;
        isGameOver = false; isPaused = false;
        bag = [];
        updateStats();
        player.next = null;
        playerReset();
        update();
    }

    document.addEventListener('keydown', e => {
        if(isGameOver && e.keyCode === 82) { resetGame(); return; }
        if(e.keyCode === 80) { isPaused=!isPaused; if(!isPaused) update(); return; }
        if(e.keyCode === 83) { volumeIndex = (volumeIndex + 1) % 4; updateSoundIcon(); return; }
        if(isPaused || isGameOver) return;
        
        if(e.keyCode === 37) playerMove(-1);
        else if(e.keyCode === 39) playerMove(1);
        else if(e.keyCode === 40) playerDrop(true); // é”®ç›˜æŒ‰ä¸‹ï¼Œä¼  trueï¼Œæœ‰éŸ³æ•ˆ
        else if(e.keyCode === 38) playerRotate(1);
        else if(e.keyCode === 32) playerHardDrop();
    });

    function bind(id, action) {
        const btn = document.getElementById(id);
        const h = (e) => { 
            e.preventDefault(); 
            if(audioCtx.state === 'suspended') audioCtx.resume(); 
            action(); 
        };
        btn.addEventListener('mousedown', h); 
        btn.addEventListener('touchstart', h, {passive: false});
    }

    bind('btn-left', ()=>!isPaused&&!isGameOver&&playerMove(-1));
    bind('btn-right', ()=>!isPaused&&!isGameOver&&playerMove(1));
    bind('btn-down', ()=>!isPaused&&!isGameOver&&playerDrop(true)); // æŒ‰é’®æŒ‰ä¸‹ï¼Œä¼  trueï¼Œæœ‰éŸ³æ•ˆ
    bind('btn-rotate', ()=>!isPaused&&!isGameOver&&playerRotate(1));
    bind('btn-drop', ()=>!isPaused&&!isGameOver&&playerHardDrop());
    bind('btn-pause', ()=>{isPaused=!isPaused; if(!isPaused)update();});
    bind('btn-reset', resetGame);
    bind('btn-sound', () => { volumeIndex = (volumeIndex + 1) % 4; updateSoundIcon(); });

    setInterval(()=>{
        const d = new Date();
        document.getElementById('clock').innerText = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }, 1000);

    updateSoundIcon();
    resetGame();
</script>
</body>
</html>
